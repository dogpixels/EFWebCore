const regStatConfig = {
    year: new Date().getFullYear(),
    state: 'open',
    // data: 'https://www.eurofurence.org/data/reg/{year}.json',
    // data: 'https://wwwtest.eurofurence.org/data/reg/{year}.json',
    data: 'http://localhost/_workfiles/temp/{year}.json'
}

class RegStats{colors={ci:{100:"#005953",80:"#338C86",60:"#66BFB9",50:"#7FD8D2",40:"#99F2EC",20:"#CCFFFF"},lanyard:{normal:"#49854b",sponsor:"#f5ca20",supersponsor:"#83559e",staff:"#e37529",director:"#dc333d"},interests:{animator:"#be89f3",artist:"#96c6fb",fursuiter:"#ff9d08",musician:"#08e5bd"}};countryCodes={AD:"Andorra",AE:"United Arab Emirates",AF:"Afghanistan",AG:"Antigua And Barbuda",AI:"Anguilla",AL:"Albania",AM:"Armenia",AN:"Netherlands Antilles",AO:"Angola",AQ:"Antarctica",AR:"Argentina",AS:"American Samoa",AT:"Austria",AU:"Australia",AW:"Aruba",AX:"Aland Islands",AZ:"Azerbaijan",BA:"Bosnia And Herzegovina",BB:"Barbados",BD:"Bangladesh",BE:"Belgium",BF:"Burkina Faso",BG:"Bulgaria",BH:"Bahrain",BI:"Burundi",BJ:"Benin",BL:"Saint Barthelemy",BM:"Bermuda",BN:"Brunei Darussalam",BO:"Bolivia",BQ:"Bonaire, Sint Eustatius and Saba",BR:"Brazil",BS:"Bahamas",BT:"Bhutan",BV:"Bouvet Island",BW:"Botswana",BY:"Belarus",BZ:"Belize",CA:"Canada",CC:"Cocos (Keeling) Islands",CD:"Congo, Democratic Republic",CF:"Central African Republic",CG:"Congo",CH:"Switzerland",CI:'Cote D"Ivoire',CK:"Cook Islands",CL:"Chile",CM:"Cameroon",CN:"China",CO:"Colombia",CR:"Costa Rica",CU:"Cuba",CV:"Cape Verde",CW:"The Country of Cura√ßao",CX:"Christmas Island",CY:"Cyprus",CZ:"Czech Republic",DE:"Germany",DJ:"Djibouti",DK:"Denmark",DM:"Dominica",DO:"Dominican Republic",DZ:"Algeria",EC:"Ecuador",EE:"Estonia",EG:"Egypt",EH:"Western Sahara",ER:"Eritrea",ES:"Spain",ET:"Ethiopia",FI:"Finland",FJ:"Fiji",FK:"Falkland Islands (Malvinas)",FM:"Micronesia, Federated States Of",FO:"Faroe Islands",FR:"France",GA:"Gabon",GB:"United Kingdom",GD:"Grenada",GE:"Georgia",GF:"French Guiana",GG:"Guernsey",GH:"Ghana",GI:"Gibraltar",GL:"Greenland",GM:"Gambia",GN:"Guinea",GP:"Guadeloupe",GQ:"Equatorial Guinea",GR:"Greece",GS:"South Georgia And Sandwich Isl.",GT:"Guatemala",GU:"Guam",GW:"Guinea-Bissau",GY:"Guyana",HK:"Hong Kong",HM:"Heard Island & Mcdonald Islands",HN:"Honduras",HR:"Croatia",HT:"Haiti",HU:"Hungary",ID:"Indonesia",IE:"Ireland",IL:"Israel",IM:"Isle Of Man",IN:"India",IO:"British Indian Ocean Territory",IQ:"Iraq",IR:"Iran, Islamic Republic Of",IS:"Iceland",IT:"Italy",JE:"Jersey",JM:"Jamaica",JO:"Jordan",JP:"Japan",KE:"Kenya",KG:"Kyrgyzstan",KH:"Cambodia",KI:"Kiribati",KM:"Comoros",KN:"Saint Kitts And Nevis",KP:"North Korea",KR:"Korea",KW:"Kuwait",KY:"Cayman Islands",KZ:"Kazakhstan",LA:'Lao People"s Democratic Republic',LB:"Lebanon",LC:"Saint Lucia",LI:"Liechtenstein",LK:"Sri Lanka",LR:"Liberia",LS:"Lesotho",LT:"Lithuania",LU:"Luxembourg",LV:"Latvia",LY:"Libyan Arab Jamahiriya",MA:"Morocco",MC:"Monaco",MD:"Moldova",ME:"Montenegro",MF:"Saint Martin",MG:"Madagascar",MH:"Marshall Islands",MK:"Macedonia",ML:"Mali",MM:"Myanmar",MN:"Mongolia",MO:"Macao",MP:"Northern Mariana Islands",MQ:"Martinique",MR:"Mauritania",MS:"Montserrat",MT:"Malta",MU:"Mauritius",MV:"Maldives",MW:"Malawi",MX:"Mexico",MY:"Malaysia",MZ:"Mozambique",NA:"Namibia",NC:"New Caledonia",NE:"Niger",NF:"Norfolk Island",NG:"Nigeria",NI:"Nicaragua",NL:"Netherlands",NO:"Norway",NP:"Nepal",NR:"Nauru",NU:"Niue",NZ:"New Zealand",OM:"Oman",PA:"Panama",PE:"Peru",PF:"French Polynesia",PG:"Papua New Guinea",PH:"Philippines",PK:"Pakistan",PL:"Poland",PM:"Saint Pierre And Miquelon",PN:"Pitcairn",PR:"Puerto Rico",PS:"Palestinian Territory, Occupied",PT:"Portugal",PW:"Palau",PY:"Paraguay",QA:"Qatar",RE:"Reunion",RO:"Romania",RS:"Serbia",RU:"Russian Federation",RW:"Rwanda",SA:"Saudi Arabia",SB:"Solomon Islands",SC:"Seychelles",SD:"Sudan",SE:"Sweden",SG:"Singapore",SH:"Saint Helena",SI:"Slovenia",SJ:"Svalbard And Jan Mayen",SK:"Slovakia",SL:"Sierra Leone",SM:"San Marino",SN:"Senegal",SO:"Somalia",SR:"Suriname",SS:"The Republic of South Sudan",ST:"Sao Tome And Principe",SV:"El Salvador",SX:"Sint Maarten",SY:"Syrian Arab Republic",SZ:"Swaziland",TC:"Turks And Caicos Islands",TD:"Chad",TF:"French Southern Territories",TG:"Togo",TH:"Thailand",TJ:"Tajikistan",TK:"Tokelau",TL:"Timor-Leste",TM:"Turkmenistan",TN:"Tunisia",TO:"Tonga",TR:"Turkey",TT:"Trinidad And Tobago",TV:"Tuvalu",TW:"Taiwan",TZ:"Tanzania",UA:"Ukraine",UG:"Uganda",UM:"United States Outlying Islands",US:"United States",UY:"Uruguay",UZ:"Uzbekistan",VA:"Holy See (Vatican City State)",VC:"Saint Vincent And Grenadines",VE:"Venezuela",VG:"Virgin Islands, British",VI:"Virgin Islands, U.S.",VN:"Vietnam",VU:"Vanuatu",WF:"Wallis And Futuna",WS:"Samoa",XK:"Kosovo",YE:"Yemen",YT:"Mayotte",ZA:"South Africa",ZM:"Zambia",ZW:"Zimbabwe"};constructor(t,a){this.datasource=t,this.regstate=a}async init(){this.data={year:0,convention:"",totalcount:0,age:{},gender:{},status:{},shirtsize:{},country:{},sponsor:{},specialinterest:{animator:0,artist:0,fursuiter:0,musician:0}},this.charts={status:this.initStatus(),types:this.initTypes(),age:this.initAge(),size:this.initSize()},this.timestampContainer=document.getElementById("ef-rs-timestamp"),this.rawContainer=document.getElementById("ef-rs-data-raw")}async update(t){this.data=await this.fetch(t),this.initTotal(),this.initInterests(),this.updateStatus(),this.updateTypes(),this.updateAge(),this.updateCountryList(),this.updateSize(),this.timestampContainer.innerText=this.data.lastchangedatetimeutc,this.rawContainer.innerText=JSON.stringify(this.data,null,4)}initTotal(){document.getElementById("ef-rs-reg-total").innerText=this.data.totalcount;const t=document.getElementById("ef-rs-reg-opening"),a=document.getElementById("ef-rs-reg-opening-indicator");switch(a.classList.remove("ef-rs-reg-opening-indicator-animation"),this.regstate){case"closed":a.style.color=this.colors.lanyard.director,t.innerText="Registrations closed";break;case"staff":a.style.color=this.colors.lanyard.staff,t.innerText="Staff registering";break;case"open":a.style.color=this.colors.lanyard.normal,a.classList.add("ef-rs-reg-opening-indicator-animation"),t.innerHTML='<a href="https://identity.eurofurence.org" target="_blank">Registrations open</a>'}}initStatus(){return new Chart(document.getElementById("ef-rs-reg-status"),{type:"doughnut",data:{labels:["New","Approved","Paid","Checked in"],datasets:[{data:[0,0,0,0],backgroundColor:[this.colors.ci[20],this.colors.ci[40],this.colors.ci[60],this.colors.ci[100]]}]},options:{plugins:{legend:{display:!1},htmlLegend:{containerID:"ef-rs-reg-status-legend",values:[0,0,0,0]}},events:[]},plugins:[htmlLegendPlugin]})}updateStatus(){const t=[this.data.status.new||0,this.data.status.approved||0,(this.data.status["partially paid"]||0)+(this.data.status.paid||0),this.data.status["checked in"]||0];this.charts.status.data.datasets[0].data=t,this.charts.status.options.plugins.htmlLegend.values=t,this.charts.status.update()}initTypes(){return new Chart(document.getElementById("ef-rs-reg-types"),{type:"doughnut",data:{labels:["Attendee","Sponsor","Super Sponsor"],datasets:[{data:[0,0,0],backgroundColor:[this.colors.lanyard.normal,this.colors.lanyard.sponsor,this.colors.lanyard.supersponsor]}]},options:{plugins:{legend:{display:!1},htmlLegend:{containerID:"ef-rs-reg-types-legend",values:[0,0,0]}},events:[]},plugins:[htmlLegendPlugin]})}updateTypes(){const t=[this.data.sponsor.normal||0,this.data.sponsor.sponsor||0,this.data.sponsor.supersponsor||0];this.charts.types.data.datasets[0].data=t,this.charts.types.options.plugins.htmlLegend.values=t,this.charts.types.update()}initInterests(){document.getElementById("ef-rs-reg-interests-animators").innerText=this.data.specialinterest.animator,document.getElementById("ef-rs-reg-interests-artists").innerText=this.data.specialinterest.artist,document.getElementById("ef-rs-reg-interests-fursuiters").innerText=this.data.specialinterest.fursuiter,document.getElementById("ef-rs-reg-interests-musicians").innerText=this.data.specialinterest.musician}initAge(){return new Chart(document.getElementById("ef-rs-age"),{type:"bar",data:{labels:[],datasets:[{data:[],backgroundColor:[]}]},options:{maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}updateAge(){const t=Object.values(this.data.age),a=t.indexOf(Math.max(...t));this.charts.age.data.labels=Object.keys(this.data.age),this.charts.age.data.datasets[0].data=t,this.charts.age.data.datasets[0].backgroundColor=this.gradient(this.colors.ci[100],this.colors.ci[20],t.length,a),this.charts.age.update()}initCountryChart(){return document.getElementById("ef-rs-country-zoom").addEventListener("click",(()=>{if(null==this.charts.countryChart.options.scales.y.max){const t=Object.values(this.data.country),a=t.indexOf(Math.max(...t));t[a]=0,this.charts.countryChart.options.scales.y.max=10*Math.ceil(1.2*Math.max(...t)/10)}else this.charts.countryChart.options.scales.y.max=void 0;this.charts.countryChart.update()})),new Chart(document.getElementById("ef-rs-country-chart"),{type:"bar",data:{labels:[],datasets:[{data:[],backgroundColor:this.colors.ci[60]}]},options:{maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}updateCountryChart(){this.charts.countryChart.data.labels=Object.keys(this.data.country),this.charts.countryChart.data.datasets[0].data=Object.values(this.data.country),this.charts.countryChart.update()}updateCountryList(){const t=document.getElementById("ef-rs-country-list");t.innerText="";for(const a in this.data.country){const e=this.countryCodes[a.toUpperCase()],n=this.data.country[a];t.innerHTML+=`<article data-iso="${a}" data-name="${e}" data-count="${n}"><div class="${a.toUpperCase()}"></div><h4>${a.toUpperCase()}</h4> ${e}<span>${n}</span></article>`}}initSize(){return new Chart(document.getElementById("ef-rs-reg-size"),{type:"doughnut",data:{labels:["XS","S","M","L","XL","XXL+","None"],datasets:[{data:[0,0,0,0,0,0,0],backgroundColor:[this.colors.ci[20],this.colors.ci[40],this.colors.ci[50],this.colors.ci[60],this.colors.ci[80],this.colors.ci[100],"#dddddd"]}]},options:{plugins:{legend:{display:!1},htmlLegend:{containerID:"ef-rs-reg-size-legend",values:[0,0,0,0,0,0,0],columns:2}},events:[]},plugins:[htmlLegendPlugin]})}updateSize(){const t=Object.values(this.data.shirtsize),a=this.data.totalcount-t.reduce(((t,a)=>t+a),0);this.charts.size.data.datasets[0].data=[...t,a],this.charts.size.options.plugins.htmlLegend.values=[...t,a],this.charts.size.update()}async fetch(t){let a=this.datasource.replace("{year}",t);a+=`?${Date.now()}`;var e=null;try{if(!(e=await(await fetch(a)).json()))throw console.info("[ef-regstats] data",e),"malformed data"}catch(t){return void console.error(`[ef-regstats] failed to load ${a}, reason: ${t}`)}return e}gradient(t,a,e,n=0){a=this.hexToRgb(a),t=this.hexToRgb(t);let i=[];for(let s=e-n-1;s<e;s++)i.push(this.rgbToHex(this.interp(a.r,t.r,e,s),this.interp(a.g,t.g,e,s),this.interp(a.b,t.b,e,s)));let s=[];for(let i=1;i<e-n;i++)s.push(this.rgbToHex(this.interp(t.r,a.r,e,i),this.interp(t.g,a.g,e,i),this.interp(t.b,a.b,e,i)));return[...i,...s]}interp(t,a,e,n){return Math.round(t+(a-t)/(e-1)*n)}hexToRgb(t){return{r:parseInt(t[1]+t[2],16),g:parseInt(t[3]+t[4],16),b:parseInt(t[5]+t[6],16)}}rgbToHex(t,a,e){return"#"+((1<<24)+(t<<16)+(a<<8)+e).toString(16).slice(1)}}const htmlLegendPlugin={id:"htmlLegend",afterUpdate(t,a,e){const n=document.getElementById(e.containerID);for(;n.firstChild;)n.firstChild.remove();const i=t.options.plugins.legend.labels.generateLabels(t);let s=t.options.plugins.htmlLegend.columns||1;for(let a=0;a<Math.min(s,2);a++){const e=document.createElement("table");if(s>1)switch(a){case 0:e.classList.add("uk-visible@s");break;case 1:e.classList.add("uk-hidden@s"),s=1}const r=Math.ceil(i.length/s);for(let a=0;a<r;a++){const n=document.createElement("tr");for(let e=0;e<s;e++){const s=a+e*r;if(s<i.length){const a=i[s],e=document.createElement("td");e.onclick=()=>{t.toggleDataVisibility(a.index),t.update()};const r=document.createElement("div");r.style.background=a.fillStyle,r.style.borderColor=a.strokeStyle,r.style.borderWidth=a.lineWidth+"px",e.appendChild(r),n.appendChild(e);const o=document.createElement("td");o.onclick=()=>{t.toggleDataVisibility(a.index),t.update()};const d=document.createElement("span");d.style.color=a.fontColor,d.style.textDecoration=a.hidden?"line-through":"",d.innerText=t.options.plugins.htmlLegend.values[s],o.appendChild(d),n.appendChild(o);const l=document.createElement("td");l.onclick=()=>{t.toggleDataVisibility(a.index),t.update()};const c=document.createElement("span");c.style.color=a.fontColor,c.style.textDecoration=a.hidden?"line-through":"",c.innerText=a.text,l.appendChild(c),n.appendChild(l)}}e.appendChild(n)}n.appendChild(e)}}},regstats=new RegStats(regStatConfig.data,regStatConfig.state);regstats.init(),regstats.update(regStatConfig.year);const timer_set=10;var timer_cur=10;const timer_div=document.getElementById("ef-rs-update");setInterval((()=>{--timer_cur<0&&(regstats.update(regStatConfig.year),timer_cur=10),timer_div.innerText=timer_cur}),1e5);
