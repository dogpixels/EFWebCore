const regStatConfig = {
    year: new Date().getFullYear(),
    state: 'open',
    // data: 'https://www.eurofurence.org/data/reg/{year}.json',
    // data: 'https://wwwtest.eurofurence.org/data/reg/{year}.json',
    data: 'http://localhost/_workfiles/temp/{year}.json'
}

class RegStats{colors={ci:{100:"#005953",80:"#338C86",60:"#66BFB9",50:"#7FD8D2",40:"#99F2EC",20:"#CCFFFF"},lanyard:{normal:"#49854b",sponsor:"#f5ca20",supersponsor:"#83559e",staff:"#e37529",director:"#dc333d"},interests:{animator:"#be89f3",artist:"#96c6fb",fursuiter:"#ff9d08",musician:"#08e5bd"}};constructor(t,e){this.datasource=t,this.regstate=e}async init(){this.data={year:0,convention:"",totalcount:0,age:{},gender:{},status:{},shirtsize:{},country:{},sponsor:{},specialinterest:{animator:0,artist:0,fursuiter:0,musician:0}},this.charts={status:this.initStatus(),types:this.initTypes(),age:this.initAge(),country:this.initCountry(),size:this.initSize()},this.timestampContainer=document.getElementById("ef-rs-timestamp"),this.rawContainer=document.getElementById("ef-rs-data-raw")}async update(t){this.data=await this.fetch(t),this.initTotal(),this.initInterests(),this.updateStatus(),this.updateTypes(),this.updateAge(),this.updateCountry(),this.updateSize(),this.timestampContainer.innerText=this.data.lastchangedatetimeutc,this.rawContainer.innerText=JSON.stringify(this.data,null,4)}initTotal(){document.getElementById("ef-rs-reg-total").innerText=this.data.totalcount;let t=document.getElementById("ef-rs-reg-opening"),e=document.getElementById("ef-rs-reg-opening-indicator");switch(e.classList.remove("ef-rs-reg-opening-indicator-animation"),this.regstate){case"closed":e.style.color=this.colors.lanyard.director,t.innerText="Registrations closed";break;case"staff":e.style.color=this.colors.lanyard.staff,t.innerText="Staff registering";break;case"open":e.style.color=this.colors.lanyard.normal,e.classList.add("ef-rs-reg-opening-indicator-animation"),t.innerHTML='<a href="https://identity.eurofurence.org" target="_blank">Registrations open</a>'}}initStatus(){return new Chart(document.getElementById("ef-rs-reg-status"),{type:"doughnut",data:{labels:["New","Approved","Paid","Checked in"],datasets:[{data:[0,0,0,0],backgroundColor:[this.colors.ci[20],this.colors.ci[40],this.colors.ci[60],this.colors.ci[100]]}]},options:{plugins:{legend:{display:!1},htmlLegend:{containerID:"ef-rs-reg-status-legend",values:[0,0,0,0]}},events:[]},plugins:[htmlLegendPlugin]})}updateStatus(){let t=[this.data.status.new||0,this.data.status.approved||0,(this.data.status["partially paid"]||0)+(this.data.status.paid||0),this.data.status["checked in"]||0];this.charts.status.data.datasets[0].data=t,this.charts.status.options.plugins.htmlLegend.values=t,this.charts.status.update()}initTypes(){return new Chart(document.getElementById("ef-rs-reg-types"),{type:"doughnut",data:{labels:["Attendee","Sponsor","Super Sponsor"],datasets:[{data:[0,0,0],backgroundColor:[this.colors.lanyard.normal,this.colors.lanyard.sponsor,this.colors.lanyard.supersponsor]}]},options:{plugins:{legend:{display:!1},htmlLegend:{containerID:"ef-rs-reg-types-legend",values:[0,0,0]}},events:[]},plugins:[htmlLegendPlugin]})}updateTypes(){let t=[this.data.sponsor.normal||0,this.data.sponsor.sponsor||0,this.data.sponsor.supersponsor||0];this.charts.types.data.datasets[0].data=t,this.charts.types.options.plugins.htmlLegend.values=t,this.charts.types.update()}initInterests(){document.getElementById("ef-rs-reg-interests-animators").innerText=this.data.specialinterest.animator,document.getElementById("ef-rs-reg-interests-artists").innerText=this.data.specialinterest.artist,document.getElementById("ef-rs-reg-interests-fursuiters").innerText=this.data.specialinterest.fursuiter,document.getElementById("ef-rs-reg-interests-musicians").innerText=this.data.specialinterest.musician}initAge(){return new Chart(document.getElementById("ef-rs-age"),{type:"bar",data:{labels:[],datasets:[{data:[],backgroundColor:[]}]},options:{maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}updateAge(){let t=Object.values(this.data.age),e=t.indexOf(Math.max(...t));this.charts.age.data.labels=Object.keys(this.data.age),this.charts.age.data.datasets[0].data=t,this.charts.age.data.datasets[0].backgroundColor=this.gradient(this.colors.ci[100],this.colors.ci[20],t.length,e),this.charts.age.update()}initCountry(){return document.getElementById("ef-rs-country-zoom").addEventListener("click",()=>{if(void 0==this.charts.country.options.scales.y.max){let t=Object.values(this.data.country),e=t.indexOf(Math.max(...t));t[e]=0,this.charts.country.options.scales.y.max=10*Math.ceil(1.2*Math.max(...t)/10)}else this.charts.country.options.scales.y.max=void 0;this.charts.country.update()}),new Chart(document.getElementById("ef-rs-country"),{type:"bar",data:{labels:[],datasets:[{data:[],backgroundColor:this.colors.ci[60]}]},options:{maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}updateCountry(){this.charts.country.data.labels=Object.keys(this.data.country),this.charts.country.data.datasets[0].data=Object.values(this.data.country),this.charts.country.update()}initSize(){return new Chart(document.getElementById("ef-rs-reg-size"),{type:"doughnut",data:{labels:["XS","S","M","L","XL","XXL+","None"],datasets:[{data:[0,0,0,0,0,0,0],backgroundColor:[this.colors.ci[20],this.colors.ci[40],this.colors.ci[50],this.colors.ci[60],this.colors.ci[80],this.colors.ci[100],"#dddddd"]}]},options:{plugins:{legend:{display:!1},htmlLegend:{containerID:"ef-rs-reg-size-legend",values:[0,0,0,0,0,0,0],columns:2}},events:[]},plugins:[htmlLegendPlugin]})}updateSize(){let t=Object.values(this.data.shirtsize),e=this.data.totalcount-t.reduce((t,e)=>t+e,0);this.charts.size.data.datasets[0].data=[...t,e],this.charts.size.options.plugins.htmlLegend.values=[...t,e],this.charts.size.update()}async fetch(t){let e=this.datasource.replace("{year}",t);e+=`?${Date.now()}`;var s=null;try{if(!(s=await (await fetch(e)).json()))throw console.info("[ef-regstats] data",s),"malformed data"}catch(a){console.error(`[ef-regstats] failed to load ${e}, reason: ${a}`);return}return s}gradient(t,e,s,a=0){e=this.hexToRgb(e),t=this.hexToRgb(t);let i=[];for(let r=s-a-1;r<s;r++)i.push(this.rgbToHex(this.interp(e.r,t.r,s,r),this.interp(e.g,t.g,s,r),this.interp(e.b,t.b,s,r)));let n=[];for(let o=1;o<s-a;o++)n.push(this.rgbToHex(this.interp(t.r,e.r,s,o),this.interp(t.g,e.g,s,o),this.interp(t.b,e.b,s,o)));return[...i,...n]}interp(t,e,s,a){return Math.round(t+(e-t)/(s-1)*a)}hexToRgb(t){return{r:parseInt(t[1]+t[2],16),g:parseInt(t[3]+t[4],16),b:parseInt(t[5]+t[6],16)}}rgbToHex(t,e,s){return"#"+(16777216+(t<<16)+(e<<8)+s).toString(16).slice(1)}}const htmlLegendPlugin={id:"htmlLegend",afterUpdate(t,e,s){let a=document.getElementById(s.containerID);for(;a.firstChild;)a.firstChild.remove();let i=t.options.plugins.legend.labels.generateLabels(t),r=document.createElement("table"),n=t.options.plugins.htmlLegend.columns||1,o=Math.ceil(i.length/n);for(let l=0;l<o;l++){let d=document.createElement("tr");for(let h=0;h<n;h++){let c=l+h*o;if(c<i.length){let u=i[c],g=document.createElement("td");g.onclick=()=>{t.toggleDataVisibility(u.index),t.update()};let p=document.createElement("div");p.style.background=u.fillStyle,p.style.borderColor=u.strokeStyle,p.style.borderWidth=u.lineWidth+"px",g.appendChild(p),d.appendChild(g);let y=document.createElement("td");y.onclick=()=>{t.toggleDataVisibility(u.index),t.update()};let $=document.createElement("span");$.style.color=u.fontColor,$.style.textDecoration=u.hidden?"line-through":"",$.innerText=t.options.plugins.htmlLegend.values[c],y.appendChild($),d.appendChild(y);let m=document.createElement("td");m.onclick=()=>{t.toggleDataVisibility(u.index),t.update()};let f=document.createElement("span");f.style.color=u.fontColor,f.style.textDecoration=u.hidden?"line-through":"",f.innerText=u.text,m.appendChild(f),d.appendChild(m)}}r.appendChild(d)}a.appendChild(r)}},regstats=new RegStats(regStatConfig.data,regStatConfig.state);regstats.init(),regstats.update(regStatConfig.year);const timer_set=10;var timer_cur=10;const timer_div=document.getElementById("ef-rs-update");setInterval(()=>{--timer_cur<0&&(regstats.update(regStatConfig.year),timer_cur=10),timer_div.innerText=timer_cur},1e3);
